name: Release Program to Mainnet

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'program-*' # Push events to matching program-*, i.e. program-circuit-breaker-0.0.1

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install toml-cli
        run: cargo install toml-cli

      - name: Build Anchor
        uses: ./.github/actions/build-anchor/

      - name: Set tag information
        run: |
          TAG=${GITHUB_REF#refs/tags/}  # Extract tag name from ref
          echo "Tag name: $TAG"
          PROGRAM=$(echo $TAG | cut -d'-' -f1)  # Extract program name from tag name
          VERSION=$(echo $TAG | cut -d'-' -f3)  # Extract version from tag name
          PROGRAM_NAME=${PROGRAM//-/_}  # Substitute dashes with underscores
          PROGRAM_ID=$(toml get programs.localnet.${PROGRAM_NAME} | tr -d '"')

          echo "Program: $PROGRAM"
          echo "Program: $PROGRAM_ID"
          echo "Version: $VERSION"
          echo "PROGRAM_ID=${PROGRAM_ID}" >> $GITHUB_ENV
          echo "PROGRAM_NAME=${PROGRAM_NAME}" >> $GITHUB_ENV
      - uses: ./.github/actions/upload-bpf/
        id: buffer-deploy
        with:
          network: mainnet-beta
          program: ${{ env.PROGRAM_NAME }}
          keypair: ${{ secrets.DEPLOYER_KEYPAIR }}
          program-id: ${{ inputs.program-id }}
          buffer-authority: ${{ secrets.MULTISIG_VAULT }}

      - name: Squads program upgrade
        uses: helium/squads-program-upgrade@v0.2.8
        with:
          network-url: 'https://api.mainnet.solana.com'
          program-multisig: ${{ secrets.MULTISIG }}
          program-id: ${{ env.PROGRAM_ID }}
          buffer: ${{ steps.buffer-deploy.outputs.buffer }}
          idl-buffer: ${{ steps.buffer-deploy.outputs.idl-buffer }}
          spill-address: ${{ secrets.DEPLOYER_ADDRESS }}
          authority: ${{ secrets.MULTISIG_VAULT }}
          name: 'Deploy ${{env.PROGRAM_NAME}} ${{env.VERSION}}'
          keypair: ${{ secrets.DEPLOYER_KEYPAIR }}
